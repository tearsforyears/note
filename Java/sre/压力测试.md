# 压力测试

[toc]


---

压力测试的工具一般有三种

- JProfile
- JMeter
- JMH

JProfile 是验证 JVM 性能的工具,用于观察 JVM 的线程状态,堆等,JMeter 是基于 HTTP 的通用压力测试工具,JMeter精度比较差但更贴近网络请求的真实结果,内有多种采样器,无需编写代码完成复杂测试(API),JMH 是 JVM 团队开发的测试工具,需要手动编写单元测试.精度比较高,用于完成对类或者方法级别的测试.

## JMH

```xml
<dependency>
  <groupId>org.openjdk.jmh</groupId>
  <artifactId>jmh-core</artifactId>
  <scope>test</scope>
</dependency>
<dependency>
  <groupId>org.openjdk.jmh</groupId>
  <artifactId>jmh-generator-annprocess</artifactId>
  <scope>test</scope>
</dependency>
```

```java

/**
 * @author jossion
 * @date 2021/8/12
 */
@Fork(1)
@Threads(8)
@Warmup(iterations = 3, time = 1)
@Measurement(iterations = 5, time = 3)
@State(value = Scope.Benchmark)
@BenchmarkMode(Mode.Throughput)
@OutputTimeUnit(TimeUnit.SECONDS)
public class EdisonServiceTest {

  private final String url = "http://edison.staging.mobiu.space/v1/domains";
  private final EdisonService edisonService = getInstance(url, ofMinutes(5), 3000, 1000, 3, true);

  @Test
  @DisplayName("TestId 生成测试用例")
  public void test1() {
    System.out.println(buildTestId());
  }

  @Test
  @DisplayName("TestId 生成测试用例")
  public void test2() {
    System.out.println(edisonService.getTestIds(new Context(ST, randomUUID().toString(), "BR")));
  }

  @Test
  @DisplayName("TestId 分布测试用例")
  public void test3() {
    TreeMap<String, Integer> counts = new TreeMap<>();
    for (int i = 0; i < 1000000; i++) {
      String testId = buildTestId();
      Integer count = counts.getOrDefault(testId, 0);
      counts.put(testId, count + 1);
    }
  }

  @Test
  @DisplayName("基准压测测试用例")
  public void test4() throws RunnerException {
    Options options = new OptionsBuilder().include(this.getClass().getName() + ".*").build();
    new Runner(options).run();
  }

  @Test
  @DisplayName("Expression 生成测试用例")
  public void test5() {
    System.out.println(edisonService.getScript(ST));
    System.out.println(edisonService.getExpression(ST));
  }

  @Test
  @DisplayName("Whitelist 测试用例")
  public void test6() {
    System.out.println(edisonService.matchWhiteList(new Context(ST, "", "BR")));
  }

  @Benchmark
  public String buildTestId() {
    return edisonService.buildTestId(new Context(ST, randomUUID().toString(), "BR"));
  }
}

```

